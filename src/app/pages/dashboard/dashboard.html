<!-- File: src/app/pages/dashboard/dashboard.html -->
<div class="hr-app">
  <!-- Animated Background -->
  <div class="bg-mesh"></div>
  
  <!-- ===== TOP NAV ===== -->
  <nav class="topnav">
    <div class="topnav-brand">
      <div class="brand-icon">HR</div>
      <span class="brand-name">PeopleOS</span>
    </div>
    <div class="topnav-right">
      <div *ngIf="me" class="user-chip">
        <div class="user-avatar-sm">{{ me.name[0] }}</div>
        <span>{{ me.name }}</span>
        <span class="role-badge">{{ me.role }}</span>
      </div>
      <button class="btn-ghost" (click)="logout()">Sign out</button>
    </div>
  </nav>

  <!-- ===== MAIN LAYOUT ===== -->
  <main class="main-content">
    <!-- ===== HEADER ===== -->
    <div class="page-header">
      <div>
        <h1 class="page-title">Employees</h1>
        <p class="page-subtitle">
          <span *ngIf="!loadingEmployees">{{ total }} total employees</span>
          <span *ngIf="loadingEmployees">Loading...</span>
        </p>
      </div>
      <div style="display: flex; gap: 10px;">
        <button class="btn-secondary" (click)="goToLeave()">üèñÔ∏è Leave</button>
        <button class="btn-secondary" (click)="goToAttendance()">üïê Attendance</button>
        <button class="btn-secondary" (click)="goToPayroll()">üí∞ Payroll</button>
        <button *ngIf="isAdmin()" class="btn-primary" (click)="openCreateModal()">
          + Add Employee
        </button>
      </div>
    </div>

    <!-- ===== STATS ROW ===== -->
    <div class="stats-row" *ngIf="!loadingEmployees">
      <div class="stat-card">
        <div class="stat-value">{{ total }}</div>
        <div class="stat-label">Total Employees</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">{{ employees.length }}</div>
        <div class="stat-label">This Page</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">{{ totalPages }}</div>
        <div class="stat-label">Total Pages</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">{{ me?.role | titlecase }}</div>
        <div class="stat-label">Your Role</div>
      </div>
    </div>

    <!-- ===== SEARCH + CONTROLS ===== -->
    <div class="controls-row">
      <div class="search-wrap">
        <span class="search-icon">‚åï</span>
        <input
          class="search-input"
          placeholder="Search by name, email, department, position..."
          [(ngModel)]="searchTerm"
          (input)="applyFilter()"
        />
        <button *ngIf="searchTerm" class="search-clear" (click)="searchTerm = ''; applyFilter()">
          ‚úï
        </button>
      </div>
      <div class="controls-right">
        <span class="count-text"> Showing {{ filteredEmployees.length }} of {{ total }} </span>
        <button class="btn-ghost" (click)="refresh()">‚Üª Refresh</button>
      </div>
    </div>

    <!-- ===== ERROR ===== -->
    <div *ngIf="employeesError" class="alert alert-error">
      ‚ö† {{ employeesError }}
      <button (click)="employeesError = ''" class="alert-close">‚úï</button>
    </div>

    <!-- ===== LOADING ===== -->
    <div *ngIf="loadingEmployees" class="loading-state">
      <div class="spinner"></div>
      <p>Loading employees...</p>
    </div>

    <!-- ===== EMPTY ===== -->
    <div
      *ngIf="!loadingEmployees && filteredEmployees.length === 0 && !employeesError"
      class="empty-state"
    >
      <div class="empty-icon">üë•</div>
      <h3>No employees found</h3>
      <p *ngIf="searchTerm">Try adjusting your search</p>
      <button *ngIf="isAdmin() && !searchTerm" class="btn-primary" (click)="openCreateModal()">
        Add First Employee
      </button>
    </div>

    <!-- ===== TABLE ===== -->
    <div *ngIf="!loadingEmployees && filteredEmployees.length > 0" class="table-wrap">
      <table class="emp-table">
        <thead>
          <tr>
            <th>Employee</th>
            <th>Email</th>
            <th>Department</th>
            <th>Position</th>
            <th>Salary</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr
            *ngFor="let e of filteredEmployees; trackBy: trackById"
            class="emp-row"
            [class.inactive-row]="!e.is_active"
          >
            <!-- Employee -->
            <td>
              <div class="emp-name-cell">
                <div class="emp-avatar" [style.background]="e.is_active ? '#6366f1' : '#9ca3af'">
                  {{ getInitials(e) }}
                </div>
                <div>
                  <div class="emp-fullname">{{ e.first_name }} {{ e.last_name }}</div>
                  <div class="emp-id">#{{ e.id }}</div>
                </div>
              </div>
            </td>
            <!-- Email -->
            <td class="text-muted">{{ e.email }}</td>
            <!-- Department -->
            <td>
              <span class="dept-badge">{{ e.department }}</span>
            </td>
            <!-- Position -->
            <td class="text-muted">{{ e.position }}</td>
            <!-- Salary -->
            <td class="salary-cell">{{ formatMoney(e.salary) }}</td>
            <!-- Status -->
            <td>
              <span
                class="status-pill"
                [class.status-active]="e.is_active"
                [class.status-inactive]="!e.is_active"
              >
                {{ e.is_active ? 'Active' : 'Inactive' }}
              </span>
            </td>
            <!-- Actions -->
            <td>
              <div class="action-btns">
                <button class="action-btn view-btn" title="View Profile" (click)="openViewModal(e)">
                  üëÅ
                </button>
                <button
                  *ngIf="isAdmin()"
                  class="action-btn edit-btn"
                  title="Edit"
                  (click)="openEditModal(e)"
                >
                  ‚úé
                </button>
                <button
                  *ngIf="isAdmin()"
                  class="action-btn salary-btn"
                  title="Update Salary"
                  (click)="openSalaryModal(e)"
                >
                  üí∞
                </button>
                <button
                  *ngIf="isAdmin() && e.is_active"
                  class="action-btn delete-btn"
                  title="Deactivate"
                  (click)="confirmDelete(e.id)"
                >
                  üóë
                </button>
                <button
                  *ngIf="isAdmin() && !e.is_active"
                  class="action-btn restore-btn"
                  title="Restore"
                  (click)="restoreEmployee(e.id)"
                >
                  ‚Ü∫
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- ===== PAGINATION ===== -->
    <div *ngIf="!loadingEmployees && total > limit" class="pagination">
      <button class="page-btn" [disabled]="page <= 1" (click)="prevPage()">‚Üê Prev</button>
      <span class="page-info">Page {{ page }} of {{ totalPages }}</span>
      <button class="page-btn" [disabled]="page >= totalPages" (click)="nextPage()">Next ‚Üí</button>
    </div>
  </main>
</div>

<!-- ========================================================= -->
<!-- ===== CREATE / EDIT MODAL ===== -->
<!-- ========================================================= -->
<div
  *ngIf="modalMode === 'create' || modalMode === 'edit'"
  class="modal-overlay active"
  (click)="closeModal()"
>
  <div class="modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>{{ modalMode === 'create' ? '+ Add New Employee' : '‚úé Edit Employee' }}</h2>
      <button class="modal-close" (click)="closeModal()">‚úï</button>
    </div>

    <div *ngIf="modalSuccess" class="alert alert-success">‚úì {{ modalSuccess }}</div>
    <div *ngIf="modalError" class="alert alert-error">‚ö† {{ modalError }}</div>

    <form [formGroup]="employeeForm" class="emp-form">
      <div class="form-row">
        <div class="form-group">
          <label>First Name *</label>
          <input
            formControlName="first_name"
            placeholder="John"
            [class.input-error]="
              hasError('first_name', 'required') || hasError('first_name', 'minlength')
            "
          />
          <span class="field-error" *ngIf="hasError('first_name', 'required')">Required</span>
          <span class="field-error" *ngIf="hasError('first_name', 'minlength')"
            >Min 2 characters</span
          >
        </div>
        <div class="form-group">
          <label>Last Name *</label>
          <input
            formControlName="last_name"
            placeholder="Doe"
            [class.input-error]="
              hasError('last_name', 'required') || hasError('last_name', 'minlength')
            "
          />
          <span class="field-error" *ngIf="hasError('last_name', 'required')">Required</span>
          <span class="field-error" *ngIf="hasError('last_name', 'minlength')"
            >Min 2 characters</span
          >
        </div>
      </div>

      <div class="form-group">
        <label>Email *</label>
        <input
          formControlName="email"
          type="email"
          placeholder="john@company.com"
          [class.input-error]="hasError('email', 'required') || hasError('email', 'email')"
        />
        <span class="field-error" *ngIf="hasError('email', 'required')">Required</span>
        <span class="field-error" *ngIf="hasError('email', 'email')">Valid email required</span>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Department *</label>
          <select
            formControlName="department"
            [class.input-error]="hasError('department', 'required')"
          >
            <option value="">Select department</option>
            <option value="IT">IT</option>
            <option value="HR">HR</option>
            <option value="Finance">Finance</option>
            <option value="Marketing">Marketing</option>
            <option value="Operations">Operations</option>
            <option value="Sales">Sales</option>
            <option value="Legal">Legal</option>
            <option value="Engineering">Engineering</option>
            <option value="Customer Support">Customer Support</option>
          </select>
          <span class="field-error" *ngIf="hasError('department', 'required')">Required</span>
        </div>
        <div class="form-group">
          <label>Position *</label>
          <input
            formControlName="position"
            placeholder="Software Developer"
            [class.input-error]="hasError('position', 'required')"
          />
          <span class="field-error" *ngIf="hasError('position', 'required')">Required</span>
        </div>
      </div>

      <div class="form-group">
        <label>Salary (ZAR) *</label>
        <input
          formControlName="salary"
          type="number"
          placeholder="35000"
          min="0"
          [class.input-error]="hasError('salary', 'required') || hasError('salary', 'min')"
        />
        <span class="field-error" *ngIf="hasError('salary', 'required')">Required</span>
        <span class="field-error" *ngIf="hasError('salary', 'min')">Must be 0 or more</span>
      </div>

      <div class="modal-actions">
        <button type="button" class="btn-ghost" (click)="closeModal()">Cancel</button>
        <button
          type="button"
          class="btn-primary"
          [disabled]="modalLoading"
          (click)="modalMode === 'create' ? submitCreate() : submitEdit()"
        >
          {{
            modalLoading ? 'Saving...' : modalMode === 'create' ? 'Create Employee' : 'Save Changes'
          }}
        </button>
      </div>
    </form>
  </div>
</div>

<!-- ========================================================= -->
<!-- ===== VIEW PROFILE MODAL ===== -->
<!-- ========================================================= -->
<div *ngIf="modalMode === 'view' && selectedEmployee" class="modal-overlay active" (click)="closeModal()">
  <div class="modal modal-profile" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Employee Profile</h2>
      <button class="modal-close" (click)="closeModal()">‚úï</button>
    </div>

    <div class="profile-hero">
      <div
        class="profile-avatar-lg"
        [style.background]="selectedEmployee.is_active ? '#6366f1' : '#9ca3af'"
      >
        {{ getInitials(selectedEmployee) }}
      </div>
      <div>
        <h2 class="profile-name">
          {{ selectedEmployee.first_name }} {{ selectedEmployee.last_name }}
        </h2>
        <p class="profile-position">
          {{ selectedEmployee.position }} ¬∑ {{ selectedEmployee.department }}
        </p>
        <span
          class="status-pill"
          [class.status-active]="selectedEmployee.is_active"
          [class.status-inactive]="!selectedEmployee.is_active"
        >
          {{ selectedEmployee.is_active ? 'Active' : 'Inactive' }}
        </span>
      </div>
    </div>

    <div class="profile-grid">
      <div class="profile-field">
        <div class="pf-label">Employee ID</div>
        <div class="pf-value">#{{ selectedEmployee.id }}</div>
      </div>
      <div class="profile-field">
        <div class="pf-label">Email</div>
        <div class="pf-value">{{ selectedEmployee.email }}</div>
      </div>
      <div class="profile-field">
        <div class="pf-label">Department</div>
        <div class="pf-value">{{ selectedEmployee.department }}</div>
      </div>
      <div class="profile-field">
        <div class="pf-label">Position</div>
        <div class="pf-value">{{ selectedEmployee.position }}</div>
      </div>
      <div class="profile-field">
        <div class="pf-label">Salary</div>
        <div class="pf-value salary-highlight">{{ formatMoney(selectedEmployee.salary) }}</div>
      </div>
      <div class="profile-field">
        <div class="pf-label">Company ID</div>
        <div class="pf-value">{{ selectedEmployee.company_id }}</div>
      </div>
      <div class="profile-field">
        <div class="pf-label">Joined</div>
        <div class="pf-value">{{ selectedEmployee.created_at | date : 'dd MMM yyyy' }}</div>
      </div>
      <div class="profile-field">
        <div class="pf-label">Status</div>
        <div class="pf-value">
          {{ selectedEmployee.is_active ? 'Active Employee' : 'Deactivated' }}
        </div>
      </div>
    </div>

    <div class="modal-actions" *ngIf="isAdmin()">
      <button class="btn-ghost" (click)="closeModal()">Close</button>
      <button class="btn-secondary" (click)="openSalaryModal(selectedEmployee!); closeModal()">
        üí∞ Update Salary
      </button>
      <button class="btn-primary" (click)="openEditModal(selectedEmployee!); modalMode = 'edit'">
        ‚úé Edit Employee
      </button>
    </div>
    <div class="modal-actions" *ngIf="!isAdmin()">
      <button class="btn-primary" (click)="closeModal()">Close</button>
    </div>
  </div>
</div>

<!-- ========================================================= -->
<!-- ===== DELETE CONFIRM MODAL ===== -->
<!-- ========================================================= -->
<div *ngIf="showDeleteConfirm" class="modal-overlay active" (click)="cancelDelete()">
  <div class="modal modal-sm" (click)="$event.stopPropagation()">
    <div class="delete-confirm-content">
      <div class="delete-icon">üóë</div>
      <h3>Deactivate Employee?</h3>
      <p>This will mark the employee as inactive. You can restore them later.</p>
      <div class="modal-actions">
        <button class="btn-ghost" (click)="cancelDelete()">Cancel</button>
        <button class="btn-danger" [disabled]="deleteLoading" (click)="executeDelete()">
          {{ deleteLoading ? 'Deactivating...' : 'Yes, Deactivate' }}
        </button>
      </div>
    </div>
  </div>
</div>

<!-- ========================================================= -->
<!-- ===== SALARY MODAL ===== -->
<!-- ========================================================= -->
<div
  *ngIf="showSalaryModal && salaryTargetEmployee"
  class="modal-overlay active"
  (click)="closeSalaryModal()"
>
  <div class="modal modal-sm" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>üí∞ Update Salary</h2>
      <button class="modal-close" (click)="closeSalaryModal()">‚úï</button>
    </div>
    <div class="salary-modal-body">
      <p class="salary-for">
        {{ salaryTargetEmployee.first_name }} {{ salaryTargetEmployee.last_name }}
      </p>
      <div class="form-group">
        <label>Current Salary</label>
        <div class="current-salary">{{ formatMoney(salaryTargetEmployee.salary) }}</div>
      </div>
      <div class="form-group">
        <label>New Salary (ZAR) *</label>
        <input type="number" [(ngModel)]="newSalary" min="0" placeholder="Enter new salary" />
      </div>
      <div *ngIf="salaryError" class="alert alert-error">‚ö† {{ salaryError }}</div>
    </div>
    <div class="modal-actions">
      <button class="btn-ghost" (click)="closeSalaryModal()">Cancel</button>
      <button
        class="btn-primary"
        [disabled]="salaryLoading || newSalary < 0"
        (click)="submitSalary()"
      >
        {{ salaryLoading ? 'Updating...' : 'Update Salary' }}
      </button>
    </div>
  </div>
</div>