<!-- File: src/app/pages/ui19/ui19.html -->
<div class="ui19-app">
  <div class="bg-mesh"></div>

  <!-- TOP NAV -->
  <nav class="topnav">
    <div class="topnav-brand">
      <div class="brand-icon">ğŸ›¡ï¸</div>
      <span class="brand-name">PeopleOS</span>
      <span class="brand-sub">/ UI-19</span>
    </div>
    <div class="topnav-right">
      <button class="btn-ghost-sm" (click)="goToDashboard()">â† Dashboard</button>
      <div *ngIf="me" class="user-chip">
        <div class="user-avatar-sm">{{ me.name[0] }}</div>
        <span>{{ me.name }}</span>
      </div>
      <button class="btn-ghost-sm" (click)="logout()">Sign out</button>
    </div>
  </nav>

  <main class="main-content">

    <!-- PAGE HEADER -->
    <div class="page-header">
      <div>
        <h1>UI-19 <span class="title-accent">UIF Declaration</span></h1>
        <p class="page-subtitle">Monthly Unemployment Insurance Fund submission â€” Department of Labour</p>
      </div>
      <div class="header-actions">
        <select class="form-select" [(ngModel)]="filterYear" (change)="loadDeclarations()">
          <option [value]="filterYear - 1">{{ filterYear - 1 }}</option>
          <option [value]="filterYear">{{ filterYear }}</option>
          <option [value]="filterYear + 1">{{ filterYear + 1 }}</option>
        </select>
        <button *ngIf="isManager()" class="btn btn-primary" (click)="activeTab = 'generate'">
          + Generate UI-19
        </button>
      </div>
    </div>

    <!-- TABS -->
    <div class="tabs">
      <button class="tab" [class.active]="activeTab === 'list'" (click)="activeTab = 'list'">
        ğŸ“‹ Declarations
      </button>
      <button *ngIf="isManager()" class="tab" [class.active]="activeTab === 'generate'" (click)="activeTab = 'generate'">
        âš™ï¸ Generate
      </button>
    </div>

    <!-- ==================== LIST TAB ==================== -->
    <div *ngIf="activeTab === 'list'">

      <div class="info-banner">
        <span class="info-icon">â„¹ï¸</span>
        <div>
          <strong>UIF Cap:</strong> R177.12 per employee per side (employee + employer = R354.24 max per person).
          Due by the <strong>7th of each month</strong> via the Department of Labour u-Filing portal.
        </div>
      </div>

      <div *ngIf="loadingDeclarations" class="loading-state">
        <div class="spinner"></div><p>Loading declarations...</p>
      </div>

      <div *ngIf="!loadingDeclarations && declarations.length === 0" class="empty-state">
        <div class="empty-icon">ğŸ›¡ï¸</div>
        <h3>No UI-19 declarations yet</h3>
        <p>Generate your first UI-19 from processed payroll records.</p>
        <button *ngIf="isManager()" class="btn btn-primary" (click)="activeTab = 'generate'">Generate UI-19</button>
      </div>

      <div *ngIf="!loadingDeclarations && declarations.length > 0" class="declarations-grid">
        <div *ngFor="let d of declarations" class="decl-card" (click)="viewDeclaration(d)">
          <div class="decl-card-top">
            <div class="decl-period">{{ getPeriodName(d.month, d.year) }}</div>
            <span class="badge" [ngClass]="getStatusClass(d.submission_status)">{{ d.submission_status }}</span>
          </div>

          <div class="decl-uif-total">{{ formatMoney(d.total_uif) }}</div>
          <div class="decl-uif-label">Total UIF Contribution</div>

          <div class="decl-stats">
            <div class="stat">
              <span class="stat-label">ğŸ‘¥ Employees</span>
              <span class="stat-value">{{ d.employee_count }}</span>
            </div>
            <div class="stat">
              <span class="stat-label">ğŸ’¼ Employee UIF</span>
              <span class="stat-value">{{ formatMoney(d.total_uif_employee) }}</span>
            </div>
            <div class="stat">
              <span class="stat-label">ğŸ¢ Employer UIF</span>
              <span class="stat-value">{{ formatMoney(d.total_uif_employer) }}</span>
            </div>
          </div>

          <div class="decl-footer">
            <span *ngIf="d.submission_date" class="submitted-info">
              âœ… Submitted {{ formatDate(d.submission_date) }}
            </span>
            <span *ngIf="!d.submission_date" class="pending-info">
              â³ Pending submission
            </span>
            <div class="card-actions" (click)="$event.stopPropagation()">
              <button class="icon-btn" title="Export CSV" (click)="exportCSV(d.id)">ğŸ“¥</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ==================== DETAIL TAB ==================== -->
    <div *ngIf="activeTab === 'detail' && selectedDeclaration">

      <div class="detail-header">
        <button class="btn-back" (click)="activeTab = 'list'">â† Back</button>
        <div class="detail-actions" *ngIf="isManager()">
          <button class="btn btn-secondary" (click)="exportCSV(selectedDeclaration.id)">ğŸ“¥ Export CSV</button>
          <button
            *ngIf="selectedDeclaration.submission_status === 'draft'"
            class="btn btn-primary"
            (click)="openSubmitModal()">
            ğŸ“¤ Mark as Submitted
          </button>
        </div>
      </div>

      <div class="summary-grid">
        <div class="summary-card card-teal">
          <div class="summary-icon">ğŸ›¡ï¸</div>
          <div class="summary-body">
            <div class="summary-value">{{ formatMoney(selectedDeclaration.total_uif) }}</div>
            <div class="summary-label">Total UIF Due</div>
          </div>
        </div>
        <div class="summary-card">
          <div class="summary-icon">ğŸ‘¤</div>
          <div class="summary-body">
            <div class="summary-value">{{ formatMoney(selectedDeclaration.total_uif_employee) }}</div>
            <div class="summary-label">Employee Contributions</div>
          </div>
        </div>
        <div class="summary-card">
          <div class="summary-icon">ğŸ¢</div>
          <div class="summary-body">
            <div class="summary-value">{{ formatMoney(selectedDeclaration.total_uif_employer) }}</div>
            <div class="summary-label">Employer Contributions</div>
          </div>
        </div>
        <div class="summary-card">
          <div class="summary-icon">ğŸ‘¥</div>
          <div class="summary-body">
            <div class="summary-value">{{ selectedDeclaration.employee_count }}</div>
            <div class="summary-label">Employees</div>
          </div>
        </div>
      </div>

      <div *ngIf="selectedDeclaration.submission_status === 'submitted'" class="submission-banner">
        âœ… Submitted to Department of Labour on {{ formatDate(selectedDeclaration.submission_date) }}
        <span *ngIf="selectedDeclaration.submission_reference"> Â· Ref: <strong>{{ selectedDeclaration.submission_reference }}</strong></span>
      </div>

      <div class="section-header">
        <h3 class="section-title">Employee UIF Breakdown</h3>
        <p class="section-sub">Click the âœï¸ icon to add/edit a UIF number for an employee</p>
      </div>

      <div *ngIf="loadingDetail" class="loading-state"><div class="spinner"></div></div>

      <div *ngIf="!loadingDetail && lineItems.length > 0" class="table-wrap">
        <table class="ui19-table">
          <thead>
            <tr>
              <th>Employee</th>
              <th>ID Number</th>
              <th>UIF Number</th>
              <th>Gross Pay</th>
              <th>Employee UIF</th>
              <th>Employer UIF</th>
              <th>Total UIF</th>
              <th>Days</th>
              <th>Edit</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let item of lineItems" class="data-row">
              <td class="name-cell">{{ item.employee_name }}</td>
              <td class="mono-cell">{{ item.id_number || 'â€”' }}</td>
              <td>
                <span *ngIf="editingLineItemId !== item.id" class="uif-num" [class.missing]="!item.uif_number">
                  {{ item.uif_number || 'Not set' }}
                </span>
                <input *ngIf="editingLineItemId === item.id"
                  class="inline-input" [(ngModel)]="editUifNumber"
                  placeholder="UIF number" />
              </td>
              <td class="money">{{ formatMoney(item.gross_remuneration) }}</td>
              <td class="money teal">{{ formatMoney(item.uif_employee) }}</td>
              <td class="money">{{ formatMoney(item.uif_employer) }}</td>
              <td class="money bold">{{ formatMoney(item.total_uif) }}</td>
              <td>
                <span *ngIf="editingLineItemId !== item.id">{{ item.days_worked }}</span>
                <input *ngIf="editingLineItemId === item.id"
                  type="number" class="inline-input days-input"
                  [(ngModel)]="editDaysWorked" min="1" max="31" />
              </td>
              <td>
                <div class="row-actions">
                  <button *ngIf="editingLineItemId !== item.id"
                    class="icon-btn" title="Edit" (click)="startEditLineItem(item)">âœï¸</button>
                  <button *ngIf="editingLineItemId === item.id"
                    class="icon-btn save-btn" title="Save" (click)="saveLineItem(item)">âœ…</button>
                  <button *ngIf="editingLineItemId === item.id"
                    class="icon-btn" title="Cancel" (click)="editingLineItemId = null">âœ•</button>
                </div>
              </td>
            </tr>
          </tbody>
          <tfoot>
            <tr class="totals-row">
              <td colspan="3"><strong>TOTALS</strong></td>
              <td class="money"><strong>{{ formatMoney(selectedDeclaration.total_remuneration) }}</strong></td>
              <td class="money teal"><strong>{{ formatMoney(selectedDeclaration.total_uif_employee) }}</strong></td>
              <td class="money"><strong>{{ formatMoney(selectedDeclaration.total_uif_employer) }}</strong></td>
              <td class="money bold"><strong>{{ formatMoney(selectedDeclaration.total_uif) }}</strong></td>
              <td colspan="2"></td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>

    <!-- ==================== GENERATE TAB ==================== -->
    <div *ngIf="activeTab === 'generate'">
      <div class="generate-card">
        <div class="generate-icon">ğŸ›¡ï¸</div>
        <h2>Generate UI-19 Declaration</h2>
        <p>Auto-generates UIF contributions from processed or paid payroll records.</p>

        <div class="generate-form">
          <div class="form-group">
            <label>Month</label>
            <select class="form-select" [(ngModel)]="generateMonth">
              <option *ngFor="let m of months" [value]="m.value">{{ m.label }}</option>
            </select>
          </div>
          <div class="form-group">
            <label>Year</label>
            <select class="form-select" [(ngModel)]="generateYear">
              <option [value]="generateYear - 1">{{ generateYear - 1 }}</option>
              <option [value]="generateYear">{{ generateYear }}</option>
            </select>
          </div>
        </div>

        <div *ngIf="generateMessage" class="alert alert-success">{{ generateMessage }}</div>
        <div *ngIf="generateError" class="alert alert-error">âŒ {{ generateError }}</div>

        <div class="generate-info">
          <div class="info-item">ğŸ›¡ï¸ UIF = 1% employee + 1% employer, capped at <strong>R177.12 each</strong></div>
          <div class="info-item">ğŸ“Œ Only <strong>processed</strong> or <strong>paid</strong> payroll records included</div>
          <div class="info-item">ğŸ”„ Re-generating an existing period will recalculate all amounts</div>
          <div class="info-item">ğŸ“¥ Export CSV to upload to the <strong>u-Filing DoL portal</strong></div>
        </div>

        <button class="btn btn-primary btn-lg" [disabled]="generateLoading" (click)="generate()">
          <span *ngIf="generateLoading" class="spinner-sm"></span>
          {{ generateLoading ? 'Generating...' : 'ğŸ›¡ï¸ Generate UI-19' }}
        </button>
      </div>
    </div>

  </main>
</div>

<!-- ===== SUBMIT MODAL ===== -->
<div *ngIf="showSubmitModal" class="modal-overlay" (click)="showSubmitModal = false">
  <div class="modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>ğŸ“¤ Mark as Submitted</h3>
      <button class="modal-close" (click)="showSubmitModal = false">âœ•</button>
    </div>
    <p class="modal-desc">Record that this UI-19 has been submitted to the Department of Labour u-Filing portal.</p>
    <div class="form-group">
      <label>Submission Reference *</label>
      <input class="form-input" [(ngModel)]="submitReference" placeholder="e.g. DOL-2026-02-001" />
    </div>
    <div class="form-group">
      <label>Notes (optional)</label>
      <textarea class="form-input" [(ngModel)]="submitNotes" rows="3" placeholder="Any notes about this submission..."></textarea>
    </div>
    <div *ngIf="submitError" class="alert alert-error">{{ submitError }}</div>
    <div class="modal-actions">
      <button class="btn btn-secondary" (click)="showSubmitModal = false">Cancel</button>
      <button class="btn btn-primary" [disabled]="submitLoading || !submitReference" (click)="submitDeclaration()">
        {{ submitLoading ? 'Saving...' : 'âœ… Confirm Submission' }}
      </button>
    </div>
  </div>
</div>